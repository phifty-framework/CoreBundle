// Generated by CoffeeScript 1.9.3

/*

	new Xhr({ 
    endpoint: '/html5/upload'
    params: {  }
    onReadyStateChange: (e) ->
  })
 */

(function() {
  if (!window.FiveKit) {
    window.FiveKit = {};
  }

  window.FiveKit.Xhr = (function() {
    function Xhr(options) {
      var self;
      this.options = options;
      if (this.options.params) {
        this.query = $.param(this.options.params);
      } else if (this.options.form) {
        this.query = $(this.options.form).serialize();
      } else if (this.options.query) {
        this.query = this.options.query;
      }
      self = this;
      this.xhr = new XMLHttpRequest;
      if (this.options.onTransferStart) {
        this.xhr.upload.addEventListener('loadstart', this.options.onTransferStart);
      }
      if (this.options.onTransferEnd) {
        this.xhr.upload.addEventListener('loadend', this.options.onTransferEnd);
      }
      if (this.options.onTransferProgress) {
        this.xhr.upload.addEventListener('progress', this.options.onTransferProgress);
      }
      this.dfd = $.Deferred();
      if (this.options.onTransferComplete) {
        this.bind('load', function(e) {
          var result, target;
          target = e.srcElement || e.target;
          if (window.console) {
            console.debug(target.responseText);
          }
          result = JSON.parse(target.responseText);
          if (window.console) {
            if (result.error) {
              console.error('result', result);
            } else {
              console.debug('result', result);
            }
          }
          self.options.onTransferComplete.call(this, e, result);
          return self.dfd.resolve();
        });
      }
      if (this.options.onTransferFailed) {
        this.bind('error', this.options.onTransferFailed);
      }
      if (this.options.onTransferCanceled) {
        this.bind('abort', this.options.onTransferCanceled);
      }
      if (this.options.onReadyStateChange) {
        this.xhr.onreadystatechange = this.options.onReadyStateChange;
      }
      this.open(this.options.endpoint, this.query);
    }

    Xhr.prototype.open = function(endpoint, query) {
      return this.xhr.open('POST', endpoint + '?' + query, true);
    };

    Xhr.prototype.bind = function(evtname, cb) {
      return this.xhr.addEventListener(evtname, cb, false);
    };

    Xhr.prototype.statechange = function(cb) {
      return this.bind('statechange', cb);
    };

    Xhr.prototype.progress = function(cb) {
      return this.bind('progress', cb);
    };

    Xhr.prototype.send = function(file) {
      var fd, mimeBuilder;
      if (typeof FormData !== "undefined") {
        if (window.console) {
          console.log("Sending file", file);
        }
        this.xhr.setRequestHeader("X-UPLOAD-FILENAME", encodeURIComponent(file.name));
        this.xhr.setRequestHeader("X-UPLOAD-SIZE", file.size);
        this.xhr.setRequestHeader("X-UPLOAD-TYPE", file.type);
        this.xhr.setRequestHeader("X-UPLOAD-MODIFIED-DATE", encodeURIComponent(file.lastModifiedDate.toISOString()));
        fd = new FormData;
        fd.append("upload", file);
        this.xhr.send(fd);
      } else if (this.xhr.sendAsBinary) {
        if (window.console) {
          console.log('sendAsBinary', file);
        }
        mimeBuilder = new FiveKit.MimeBuilder;
        mimeBuilder.build({
          file: file,
          onBuilt: (function(_this) {
            return function(b) {
              console.log("body", b);
              return _this.xhr.sendAsBinary(b.body);
            };
          })(this)
        });
      }
      return this.dfd;
    };

    return Xhr;

  })();

}).call(this);
